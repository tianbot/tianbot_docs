<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TIANBOT Wi-Fi 配置</title>

  <!-- PWA 配置 -->
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIuWKoOWFgyBXaS1GaSBN6Z2i5YqoIiwKICAic2hvcnRfbmFtZSI6ICLmloflj6ciLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3d3dy50aWFuYm90LmNvbS9mYXZpY29uLmljbyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvaWNvIgogICAgfQogIF0sCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjVmNWY1IiwKICAidGhlbWVfY29sb3IiOiAiIzAwN2JmZiIKfQ==">
  <link rel="icon" href="https://www.tianbot.com/favicon.ico">
  <meta name="theme-color" content="#007bff">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f0f2f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    h2, h3, h4 {
      margin-top: 0;
      color: #1a2a4c;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
      transition: background-color 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #a0c3e7;
      cursor: not-allowed;
    }
    #getParamsBtn {
      background: #17a2b8; /* 使用青色以区分功能 */
    }
    #getParamsBtn:hover {
      background: #138496;
    }
    #installBtn {
      background: #28a745;
    }
    #installBtn:hover {
      background: #218838;
    }
    #powerOffBtn {
      background: #dc3545; /* 红色按钮 */
    }
    #powerOffBtn:hover {
      background: #c82333;
    }

    /* 新增：按钮组布局 */
    .button-group-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .button-group-left, .button-group-right {
      display: flex;
      gap: 5px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    /* 新增：输入验证错误提示样式 */
    .input-error {
      border-color: #dc3545 !important;
      background-color: #fff8f8;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: -5px;
      margin-bottom: 8px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    .log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', Courier, monospace;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .pending { background: #fff3cd; color: #856404; }
    
    /* 设备状态面板 */
    .status-panel {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px 15px;
      align-items: center;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .status-label {
      font-weight: 600;
      color: #495057;
    }

    .status-value {
      font-weight: 400;
      color: #212529;
      word-break: break-all;
    }

    .status-value.success { color: #28a745; }
    .status-value.error { color: #dc3545; }
    .status-value.pending { color: #ffc107; }
    
    /* 新增: 禁用状态样式 */
    .status-value.disabled {
      color: #6c757d;
      font-style: italic;
    }

    /* 标签页样式 */
    .tab-bar {
      display: flex;
      background-color: #e9ecef;
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    .tab-button {
      flex-grow: 1;
      padding: 12px 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background-color: transparent;
      color: #6c757d;
      transition: background-color 0.2s, color 0.2s;
      border-radius: 0;
      margin: 0;
    }
    .tab-button:hover {
      background-color: #dce1e6;
    }
    .tab-button.active {
      background-color: #007bff;
      color: white;
    }
    .tab-panel {
      display: none;
      padding: 20px;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 8px 8px;
      background-color: #fff;
    }
    .tab-panel.active {
      display: block;
    }

    /* IP 地址显示样式 */
    .ip-display {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }

    /* ROS 版本标签样式 */
    .ros-version-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    .ros-version-badge.ros1 {
      background-color: #007bff;
      color: white;
    }
    .ros-version-badge.ros2 {
      background-color: #28a745;
      color: white;
    }

    /* 禁用标签页 */
    .tab-button.disabled {
      background-color: #e9ecef;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* 自定义确认对话框样式 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-dialog {
      background-color: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal-dialog {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-icon {
      width: 48px;
      height: 48px;
      background-color: #f8d7da;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .modal-icon svg {
      width: 24px;
      height: 24px;
      fill: #dc3545;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a2a4c;
      margin: 0;
    }

    .modal-body {
      color: #495057;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .modal-btn-cancel {
      background-color: #e9ecef;
      color: #495057;
    }

    .modal-btn-cancel:hover {
      background-color: #dee2e6;
    }

    .modal-btn-confirm {
      background-color: #dc3545;
      color: white;
    }

    .modal-btn-confirm:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>

  <div class="card">
    <h2>TIANBOT Wi-Fi 配置工具</h2>
    <p id="bluetoothHint" style="display:none; color:#d63939;">
      检测到蓝牙未开启，请在手机设置中打开蓝牙后刷新页面。
    </p>
    
    <!-- 按钮组布局 -->
    <div class="button-group-container">
      <div class="button-group-left">
        <button id="connectBtn">连接设备</button>
        <button id="disconnectBtn" disabled>断开连接</button>
      </div>
      <div class="button-group-right">
        <button id="getParamsBtn" disabled>获取配置信息</button>
        <button id="powerOffBtn" disabled>关机</button>
        <button id="installBtn" style="display:none;">安装到桌面</button>
      </div>
    </div>
  </div>

  <!-- Wi-Fi 配置卡片 -->
  <div class="card" id="configCard" style="display:none;">
    <h3>发送 Wi-Fi 配置</h3>
    <input type="text" id="ssid" placeholder="Wi-Fi 名称 (SSID)" />
    <input type="text" id="pwd" placeholder="Wi-Fi 密码" autocomplete="off" />
    <input type="text" id="phoneIP" placeholder="手机 IP（可选）" />
    <button id="sendBtn">发送配置</button>
  </div>

  <!-- ROS 配置标签页卡片 -->
  <div class="card" id="rosConfigCard" style="display:none;">
    <h3>ROS 配置</h3>
    <div class="tab-bar">
      <button class="tab-button active" id="ros1TabBtn">ROS1</button>
      <button class="tab-button" id="ros2TabBtn">ROS2</button>
    </div>

    <!-- ROS1 配置面板 -->
    <div class="tab-panel active" id="ros1Panel">
      <h4>ROS1 配置</h4>
      <input type="text" id="ros1_robot_name" placeholder="ROBOT_NAME" />
      <div class="error-message" id="ros1_robot_name_error">ROBOT_NAME 只能包含英文字母、数字和下划线</div>
      <input type="text" id="ros1_master_uri" placeholder="ROS_MASTER_URI (e.g., http://192.168.1.100:11311)" />
      <input type="text" id="ros1_up_start" placeholder="UP_START (e.g., roscore, turtlebot3_teleop)" />
      <button id="sendRos1Btn">发送 ROS1 配置</button>
    </div>

    <!-- ROS2 配置面板 -->
    <div class="tab-panel" id="ros2Panel">
      <h4>ROS2 配置</h4>
      <input type="text" id="ros2_robot_name" placeholder="ROBOT_NAME" />
      <div class="error-message" id="ros2_robot_name_error">ROBOT_NAME 只能包含英文字母、数字和下划线</div>
      <input type="text" id="ros2_domain_id" placeholder="ROS_DOMAIN_ID (e.g., 0, 24)" />
      <div class="error-message" id="ros2_domain_id_error">ROS_DOMAIN_ID 只能包含数字</div>
      <input type="text" id="ros2_up_start" placeholder="UP_START (e.g., on, off)" />
      <button id="sendRos2Btn">发送 ROS2 配置</button>
    </div>
  </div>

  <!-- 设备状态通知卡片 -->
  <div class="card">
    <h3>设备状态通知</h3>
    
    <!-- 增加了版本、设备名称、Domain ID、RMIP 和 ROSIP 的显示，并添加 ROS 版本标签 -->
    <div class="status-panel">
      <span class="status-label">版本:</span>
      <span id="status-version" class="status-value">--</span>

      <span class="status-label">ROS 类型:</span>
      <span id="status-ros-type" class="status-value">
        <span id="ros-type-text">--</span>
        <span id="ros-version-badge" class="ros-version-badge" style="display:none;"></span>
      </span>

      <span class="status-label">设备名称:</span>
      <span id="status-name" class="status-value">--</span>

      <span class="status-label">Domain ID:</span>
      <span id="status-domain-id" class="status-value ip-display">--</span>
      
      <span class="status-label">SSID:</span>
      <span id="status-ssid" class="status-value">--</span>
      
      <span class="status-label">设备IP:</span>
      <span id="status-ip" class="status-value ip-display">--</span>
      
      <span class="status-label">RMIP:</span>
      <span id="status-rmip" class="status-value ip-display">--</span>
      
      <span class="status-label">ROSIP:</span>
      <span id="status-rosip" class="status-value ip-display">--</span>
      
      <span class="status-label">Wi-Fi 状态:</span>
      <span id="status-wifi" class="status-value">--</span>
      
      <span class="status-label">ROS 状态:</span>
      <span id="status-ros" class="status-value">--</span>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e9ecef;">

    <h4>操作日志</h4>
    <div id="status" class="status info">未连接</div>
    <div id="log" class="log"></div>
  </div>

  <!-- 自定义确认对话框 -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-header">
        <div class="modal-icon">
          <svg viewBox="0 0 24 24">
            <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z" />
          </svg>
        </div>
        <h3 class="modal-title">确认关机</h3>
      </div>
      <div class="modal-body">
        您确定要关闭设备吗？设备关机后需要通过物理方式重新启动。
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" id="cancelPowerOff">取消</button>
        <button class="modal-btn modal-btn-confirm" id="confirmPowerOff">确认关机</button>
      </div>
    </div>
  </div>

  <script>
    // UUID 定义
    const SERVICE_UUID = '0000c420-0000-1000-8000-00805f9b34fb';
    const CHAR_WRITE_UUID = '0000c421-0000-1000-8000-00805f9b34fb';
    const CHAR_NOTIFY_UUID = '0000c422-0000-1000-8000-00805f9b34fb';

    // 状态映射
    const STATUS_MAP = {
      0: { text: '无状态', type: 'info' },
      1: { text: '获取信息中', type: 'pending' },
      2: { text: '开始连接', type: 'pending' },
      3: { text: '连接中...', type: 'pending' },
      4: { text: '无此 SSID', type: 'error' },
      5: { text: '密码错误', type: 'error' },
      6: { text: '其他错误', type: 'error' },
      7: { text: '连接成功', type: 'success' },
      8: { text: '重启中', type: 'pending' },
      12: { text: '运行中', type: 'success' },
      16: { text: '连接失败', type: 'error' }
    };

    let device, server, service, writeChar, notifyChar;
    let reconnectTimer;
    let currentRosVersion = null; // 'ros1' or 'ros2'
    let configInitialized = false; // 标记是否已收到完整配置信息
    const logElement = document.getElementById('log');
    const statusElement = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const getParamsBtn = document.getElementById('getParamsBtn');
    const powerOffBtn = document.getElementById('powerOffBtn'); // 关机按钮
    const configCard = document.getElementById('configCard');
    const rosConfigCard = document.getElementById('rosConfigCard');
    const installBtn = document.getElementById('installBtn');
    const bluetoothHint = document.getElementById('bluetoothHint');
    
    // 确认对话框元素
    const confirmModal = document.getElementById('confirmModal');
    const cancelPowerOff = document.getElementById('cancelPowerOff');
    const confirmPowerOff = document.getElementById('confirmPowerOff');

    // 输入框元素
    const ssidInput = document.getElementById('ssid');
    const pwdInput = document.getElementById('pwd');
    const ipInput = document.getElementById('phoneIP');

    // ROS 标签页元素
    const ros1TabBtn = document.getElementById('ros1TabBtn');
    const ros2TabBtn = document.getElementById('ros2TabBtn');
    const ros1Panel = document.getElementById('ros1Panel');
    const ros2Panel = document.getElementById('ros2Panel');

    // 输入验证函数
    function validateRobotName(value) {
      // ROBOT_NAME 只允许英文字母、数字和下划线
      // 不允许中文字符、连字符(-)和其他特殊字符
      const pattern = /^[a-zA-Z0-9_]*$/;
      return pattern.test(value);
    }

    function validateDomainId(value) {
      // ROS_DOMAIN_ID 只允许数字
      const pattern = /^[0-9]*$/;
      return pattern.test(value);
    }

    // 显示错误信息
    function showError(inputId, errorId) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);
      input.classList.add('input-error');
      error.classList.add('show');
    }

    // 隐藏错误信息
    function hideError(inputId, errorId) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);
      input.classList.remove('input-error');
      error.classList.remove('show');
    }

    // 实时输入验证
    function setupInputValidation() {
      // ROS1 ROBOT_NAME 验证
      const ros1RobotName = document.getElementById('ros1_robot_name');
      ros1RobotName.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value && !validateRobotName(value)) {
          // 移除无效字符
          const validValue = value.replace(/[^a-zA-Z0-9_]/g, '');
          e.target.value = validValue;
          showError('ros1_robot_name', 'ros1_robot_name_error');
          log('ROBOT_NAME 包含无效字符，已自动清除', 'error');
        } else {
          hideError('ros1_robot_name', 'ros1_robot_name_error');
        }
      });

      // ROS2 ROBOT_NAME 验证
      const ros2RobotName = document.getElementById('ros2_robot_name');
      ros2RobotName.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value && !validateRobotName(value)) {
          // 移除无效字符
          const validValue = value.replace(/[^a-zA-Z0-9_]/g, '');
          e.target.value = validValue;
          showError('ros2_robot_name', 'ros2_robot_name_error');
          log('ROBOT_NAME 包含无效字符，已自动清除', 'error');
        } else {
          hideError('ros2_robot_name', 'ros2_robot_name_error');
        }
      });

      // ROS2 DOMAIN_ID 验证
      const ros2DomainId = document.getElementById('ros2_domain_id');
      ros2DomainId.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value && !validateDomainId(value)) {
          // 移除无效字符
          const validValue = value.replace(/[^0-9]/g, '');
          e.target.value = validValue;
          showError('ros2_domain_id', 'ros2_domain_id_error');
          log('ROS_DOMAIN_ID 只能包含数字，已自动清除其他字符', 'error');
        } else {
          hideError('ros2_domain_id', 'ros2_domain_id_error');
        }
      });

      // 防止粘贴非法字符
      [ros1RobotName, ros2RobotName, ros2DomainId].forEach(input => {
        input.addEventListener('paste', function(e) {
          // 延迟执行，让粘贴完成后再验证
          setTimeout(() => {
            const event = new Event('input', { bubbles: true });
            input.dispatchEvent(event);
          }, 10);
        });
      });
    }

    // PWA 安装
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });
    installBtn.addEventListener('click', () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') {
          log('用户已安装 PWA 到桌面', 'success');
        }
        deferredPrompt = null;
      });
    });

    // 日志函数
    function log(msg, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}\n`;
      logElement.textContent += line;
      logElement.scrollTop = logElement.scrollHeight;
    }

    // 从 localStorage 加载所有配置
    function loadSavedConfigs() {
      // 加载 Wi-Fi 配置
      const wifiConfig = JSON.parse(localStorage.getItem('wifiConfig') || '{}');
      ssidInput.value = wifiConfig.ssid || '';
      pwdInput.value = wifiConfig.pwd || '';
      ipInput.value = wifiConfig.ip || '';

      // 加载 ROS1 配置
      const ros1Config = JSON.parse(localStorage.getItem('ros1Config') || '{}');
      document.getElementById('ros1_robot_name').value = ros1Config.robot_name || '';
      document.getElementById('ros1_master_uri').value = ros1Config.ros_master_uri || '';
      document.getElementById('ros1_up_start').value = ros1Config.up_start || '';

      // 加载 ROS2 配置
      const ros2Config = JSON.parse(localStorage.getItem('ros2Config') || '{}');
      document.getElementById('ros2_robot_name').value = ros2Config.robot_name || '';
      document.getElementById('ros2_domain_id').value = ros2Config.domain_id || '';
      document.getElementById('ros2_up_start').value = ros2Config.up_start || '';
    }

    // 保存配置到 localStorage
    function saveWifiConfig() {
      const wifiConfig = {
        ssid: ssidInput.value.trim(),
        pwd: pwdInput.value,
        ip: ipInput.value.trim()
      };
      localStorage.setItem('wifiConfig', JSON.stringify(wifiConfig));
    }
    
    function saveRos1Config() {
      const ros1Config = {
        robot_name: document.getElementById('ros1_robot_name').value.trim(),
        ros_master_uri: document.getElementById('ros1_master_uri').value.trim(),
        up_start: document.getElementById('ros1_up_start').value.trim()
      };
      localStorage.setItem('ros1Config', JSON.stringify(ros1Config));
    }

    function saveRos2Config() {
      const ros2Config = {
        robot_name: document.getElementById('ros2_robot_name').value.trim(),
        domain_id: document.getElementById('ros2_domain_id').value.trim(),
        up_start: document.getElementById('ros2_up_start').value.trim()
      };
      localStorage.setItem('ros2Config', JSON.stringify(ros2Config));
    }

    // 更新 ROS 版本标签和相关标签页状态
    function updateRosVersion(version) {
      currentRosVersion = null;
      const rosTypeText = document.getElementById('ros-type-text');
      const rosVersionBadge = document.getElementById('ros-version-badge');
      
      if (!version) {
        rosTypeText.textContent = '未知';
        rosVersionBadge.style.display = 'none';
        
        // 两个标签页都禁用
        ros1TabBtn.classList.add('disabled');
        ros2TabBtn.classList.add('disabled');
        return false; // 返回false表示未识别出ROS版本
      }
      
      if (version.includes('robot-startup-ros2')) {
        currentRosVersion = 'ros2';
        rosTypeText.textContent = 'ROS2';
        rosVersionBadge.textContent = 'ROS2';
        rosVersionBadge.className = 'ros-version-badge ros2';
        rosVersionBadge.style.display = 'inline-block';
        
        // 激活 ROS2 标签页，禁用 ROS1
        ros2TabBtn.classList.remove('disabled');
        ros1TabBtn.classList.add('disabled');
        
        // 如果当前在 ROS1 标签页，切换到 ROS2
        if (ros1Panel.classList.contains('active')) {
          switchTab('ros2');
        }
        return true; // 返回true表示已识别出ROS版本
      } else if (version.includes('robot-startup-ros1')) {
        currentRosVersion = 'ros1';
        rosTypeText.textContent = 'ROS1';
        rosVersionBadge.textContent = 'ROS1';
        rosVersionBadge.className = 'ros-version-badge ros1';
        rosVersionBadge.style.display = 'inline-block';
        
        // 激活 ROS1 标签页，禁用 ROS2
        ros1TabBtn.classList.remove('disabled');
        ros2TabBtn.classList.add('disabled');
        
        // 如果当前在 ROS2 标签页，切换到 ROS1
        if (ros2Panel.classList.contains('active')) {
          switchTab('ros1');
        }
        return true; // 返回true表示已识别出ROS版本
      } else {
        // 未知版本
        rosTypeText.textContent = '未知';
        rosVersionBadge.style.display = 'none';
        
        // 两个标签页都禁用
        ros1TabBtn.classList.add('disabled');
        ros2TabBtn.classList.add('disabled');
        return false; // 返回false表示未识别出ROS版本
      }
    }

    // 完全重写更新设备状态面板函数以适应新数据，增加 RMIP 和 ROSIP 字段，并根据 ROS 版本控制字段显示
    function updateDeviceStatus(data) {
      // 更新基本信息
      document.getElementById('status-version').textContent = data.version || '--';
      
      // 更新 ROS 版本和相关标签页状态
      const rosVersionIdentified = updateRosVersion(data.version);
      
      // 只有在识别出ROS版本时才更新其他字段
      if (rosVersionIdentified) {
        document.getElementById('status-name').textContent = data.name || '--';
        
        // 更新 Domain ID - ROS2 版本才显示
        const domainIdEl = document.getElementById('status-domain-id');
        if (currentRosVersion === 'ros2') {
          domainIdEl.textContent = data.domain_id || '--';
          domainIdEl.className = 'status-value ip-display';
        } else {
          domainIdEl.textContent = '当前ROS版本下不可用';
          domainIdEl.className = 'status-value ip-display disabled';
        }
        
        // 更新网络信息
        const ssidEl = document.getElementById('status-ssid');
        ssidEl.textContent = data.ssid || '--';
        
        const ipEl = document.getElementById('status-ip');
        const devIp = data.devip || data.ip; // 兼容旧数据
        ipEl.textContent = devIp || '--';
        ipEl.className = devIp ? 'status-value ip-display success' : 'status-value ip-display error';

        // 处理 RMIP 字段 - 仅 ROS1 版本显示
        const rmipEl = document.getElementById('status-rmip');
        if (currentRosVersion === 'ros1') {
          const rmip = data.rmip;
          rmipEl.textContent = rmip || '--';
          rmipEl.className = rmip ? 'status-value ip-display success' : 'status-value ip-display error';
        } else {
          rmipEl.textContent = '当前ROS版本下不可用';
          rmipEl.className = 'status-value ip-display disabled';
        }
        
        // 处理 ROSIP 字段 - 仅 ROS1 版本显示
        const rosipEl = document.getElementById('status-rosip');
        if (currentRosVersion === 'ros1') {
          const rosip = data.rosip;
          rosipEl.textContent = rosip || '--';
          rosipEl.className = rosip ? 'status-value ip-display success' : 'status-value ip-display error';
        } else {
          rosipEl.textContent = '当前ROS版本下不可用';
          rosipEl.className = 'status-value ip-display disabled';
        }

        // 智能判断 Wi-Fi 状态
        const wifiEl = document.getElementById('status-wifi');
        if (devIp) {
          wifiEl.textContent = '连接成功';
          wifiEl.className = 'status-value success';
        } else if (data.ssid) {
          wifiEl.textContent = '已配置，未连接';
          wifiEl.className = 'status-value pending';
        } else {
          wifiEl.textContent = '未配置';
          wifiEl.className = 'status-value error';
        }
        
        // 根据 upstart 字段判断 ROS 状态
        const rosEl = document.getElementById('status-ros');
        const upstartStatus = STATUS_MAP[data.upstart];
        if (upstartStatus) {
            rosEl.className = `status-value ${upstartStatus.type}`;
            rosEl.textContent = upstartStatus.text;
        } else {
            rosEl.textContent = '--';
            rosEl.className = 'status-value';
        }
        
        // 标记已收到完整配置
        if (!configInitialized) {
          configInitialized = true;
          log('设备配置信息已完全加载', 'success');
        }
      } else {
        // 未识别出ROS版本，只显示版本信息
        document.getElementById('status-version').textContent = data.version || '--';
        log('收到数据但无法识别ROS版本，等待完整配置信息...', 'info');
      }
    }

    // 处理设备通知，增加预处理步骤和版本检查
    function handleNotify(event) {
      const rawStr = new TextDecoder('utf-8').decode(event.target.value);
      log('收到设备通知');
      
      // 转换类 Python 字典字符串为 JSON
      let jsonStr = rawStr
        .replace(/'/g, '"') // 替换单引号为双引号
        .replace(/None/g, 'null') // 替换 Python 的 None 为 JSON 的 null
        .replace(/,\s*}/g, '}'); // 移除对象字面量末尾多余的逗号

      try {
        const data = JSON.parse(jsonStr);
        console.log('Received data:', data);
        
        // 检查是否包含version字段
        if (!data.version) {
          log('收到不完整数据（缺少version字段），忽略更新', 'info');
          return; // 不更新UI
        }
        
        // 检查version是否能识别ROS版本
        if (!data.version.includes('robot-startup-ros1') && !data.version.includes('robot-startup-ros2')) {
          log(`收到数据但无法识别ROS版本: ${data.version}`, 'info');
          return; // 不更新UI
        }
        
        // 调用更新函数
        updateDeviceStatus(data);

        // 更新顶部通用状态栏
        statusElement.textContent = '已获取设备最新状态';
        statusElement.className = 'status info';
        
      } catch (e) {
        // 将原始字符串也记录下来，方便调试
        log(`通知解析失败: ${rawStr}`, 'error'); 
        statusElement.textContent = '数据解析错误';
        statusElement.className = 'status error';
      }
    }

    // 蓝牙检查
    async function checkBluetooth() {
      if (!navigator.bluetooth) {
        log('浏览器不支持 Web Bluetooth', 'error');
        return false;
      }
      const available = await navigator.bluetooth.getAvailability();
      if (!available) {
        bluetoothHint.style.display = 'block';
        log('蓝牙未开启，请打开后刷新', 'error');
        return false;
      }
      bluetoothHint.style.display = 'none';
      return true;
    }

    // 自动连接
    async function autoConnect() {
      const deviceId = localStorage.getItem('pairedDeviceId');
      if (!deviceId) return false;
      try {
        log('正在自动连接已配对设备...');
        device = await navigator.bluetooth.requestDevice({ filters: [{ deviceId }], optionalServices: [SERVICE_UUID] });
        await connectGATT();
        return true;
      } catch (e) {
        localStorage.removeItem('pairedDeviceId');
        log('自动连接失败，将重新扫描', 'error');
        return false;
      }
    }

    // 连接 GATT
    async function connectGATT() {
      server = await device.gatt.connect();
      log('正在连接 GATT 服务器...');
      service = await server.getPrimaryService(SERVICE_UUID);
      writeChar = await service.getCharacteristic(CHAR_WRITE_UUID);
      notifyChar = await service.getCharacteristic(CHAR_NOTIFY_UUID);

      await notifyChar.startNotifications();
      notifyChar.addEventListener('characteristicvaluechanged', handleNotify);

      log(`连接成功！设备: ${device.name}`, 'success');
      statusElement.textContent = '已连接，等待配置信息...';
      statusElement.className = 'status pending';
      
      localStorage.setItem('pairedDeviceId', device.id);
      connectBtn.disabled = true;
      disconnectBtn.disabled = false;
      getParamsBtn.disabled = false;
      powerOffBtn.disabled = false; // 启用关机按钮
      configCard.style.display = 'block';
      rosConfigCard.style.display = 'block';
    }

    // 连接按钮
    connectBtn.addEventListener('click', async () => {
      if (!(await checkBluetooth())) return;
      try {
        log('正在请求蓝牙设备...');
        device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
        await connectGATT();
      } catch (error) {
        if (error.name !== 'NotFoundError') {
          log(`连接失败: ${error.message}`, 'error');
        }
      }
    });

    // =================================================================
    // 页面刷新前断开连接
    // =================================================================

    // 提取断开连接的核心逻辑
    function performDisconnect() {
      if (server && server.connected) {
        log('页面刷新或关闭，正在主动断开连接...', 'info');
        server.disconnect();
      }
    }

    // 修改"断开连接"按钮的事件，复用核心逻辑
    disconnectBtn.addEventListener('click', () => {
      performDisconnect();
      resetUI();
    });
    
    // 关键：监听页面卸载前事件，执行断开操作
    window.addEventListener('beforeunload', () => {
      performDisconnect();
    });
    
    // 断线重连
    function scheduleReconnect() {
      if (reconnectTimer) clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(async () => {
        if (!device || !localStorage.getItem('pairedDeviceId')) return;
        log('断线重连中...');
        try {
          await connectGATT();
        } catch (e) {
          scheduleReconnect();
        }
      }, 3000);
    }

    window.addEventListener('gattserverdisconnected', () => {
      log('设备已断开，3秒后自动重连...', 'info');
      resetUI();
      scheduleReconnect();
    });

    // 重置 UI，包括新增字段 RMIP 和 ROSIP，以及 ROS 版本
    function resetUI() {
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      getParamsBtn.disabled = true;
      powerOffBtn.disabled = true; // 禁用关机按钮
      configCard.style.display = 'none';
      rosConfigCard.style.display = 'none';
      if (reconnectTimer) clearTimeout(reconnectTimer);

      // 重置 ROS 版本
      configInitialized = false; // 重置配置初始化标记
      currentRosVersion = null;
      document.getElementById('status-version').textContent = '--';
      document.getElementById('ros-type-text').textContent = '--';
      document.getElementById('ros-version-badge').style.display = 'none';
      
      // 重置标签页状态
      ros1TabBtn.classList.remove('disabled');
      ros2TabBtn.classList.remove('disabled');
      ros1TabBtn.classList.add('active');
      ros2TabBtn.classList.remove('active');
      ros1Panel.classList.add('active');
      ros2Panel.classList.remove('active');
      
      document.getElementById('status-name').textContent = '--';
      document.getElementById('status-domain-id').textContent = '--';
      document.getElementById('status-ssid').textContent = '--';
      document.getElementById('status-ip').textContent = '--';
      document.getElementById('status-rmip').textContent = '--';
      document.getElementById('status-rosip').textContent = '--';
      document.getElementById('status-wifi').textContent = '--';
      document.getElementById('status-ros').textContent = '--';

      statusElement.textContent = '未连接';
      statusElement.className = 'status info';
    }

    // 统一处理发送错误
    function handleSendError(error) {
      if (error.message.includes('GATT Server is disconnected')) {
        log('发送失败：连接已断开，即将自动重连...', 'error');
        statusElement.textContent = '连接已断开，尝试自动重连...';
        statusElement.className = 'status pending';
        resetUI();
        scheduleReconnect();
      } else {
        log(`发送失败: ${error.message}`, 'error');
      }
    }

    // 发送 Wi-Fi 配置
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const ssid = ssidInput.value.trim();
      const pwd = pwdInput.value;
      const ip = ipInput.value.trim();

      if (!ssid) {
        log('请输入 Wi-Fi 名称！', 'error');
        return;
      }

      const payload = { ssid, pwd: pwd || "", ip: ip || "" };
      try {
        const data = new TextEncoder().encode(JSON.stringify(payload));
        await writeChar.writeValueWithoutResponse(data);
        log(`已发送配置 → SSID: ${ssid} (${ip || '无IP'})`, 'success');
        saveWifiConfig();
      } catch (error) {
        handleSendError(error);
      }
    });

    // 发送 ROS1 配置
    document.getElementById('sendRos1Btn').addEventListener('click', async () => {
      const robot_name = document.getElementById('ros1_robot_name').value.trim();
      const ros_master_uri = document.getElementById('ros1_master_uri').value.trim();
      const up_start = document.getElementById('ros1_up_start').value.trim();
      
      // 验证 ROBOT_NAME
      if (robot_name && !validateRobotName(robot_name)) {
        log('ROBOT_NAME 包含无效字符，只允许英文字母、数字和下划线', 'error');
        showError('ros1_robot_name', 'ros1_robot_name_error');
        return;
      }
      
      const payload = {
        cmd: "ros1_config",
        ns: robot_name || "",
        master_uri: ros_master_uri || "",
        upstart: up_start || ""
      };

      try {
        const data = new TextEncoder().encode(JSON.stringify(payload));
        await writeChar.writeValueWithoutResponse(data);
        log(`已发送 ROS1 配置 → ROBOT_NAME: ${robot_name || '空'}`, 'success');
        saveRos1Config();
      } catch (error) {
        handleSendError(error);
      }
    });

    // 发送 ROS2 配置
    document.getElementById('sendRos2Btn').addEventListener('click', async () => {
      const robot_name = document.getElementById('ros2_robot_name').value.trim();
      const ros_domain_id = document.getElementById('ros2_domain_id').value.trim();
      const up_start = document.getElementById('ros2_up_start').value.trim();
      
      // 验证 ROBOT_NAME
      if (robot_name && !validateRobotName(robot_name)) {
        log('ROBOT_NAME 包含无效字符，只允许英文字母、数字和下划线', 'error');
        showError('ros2_robot_name', 'ros2_robot_name_error');
        return;
      }
      
      // 验证 DOMAIN_ID
      if (ros_domain_id && !validateDomainId(ros_domain_id)) {
        log('ROS_DOMAIN_ID 包含无效字符，只允许数字', 'error');
        showError('ros2_domain_id', 'ros2_domain_id_error');
        return;
      }

      const payload = {
        cmd: "ros2_config",
        ns: robot_name || "",
        domain_id: ros_domain_id || "",
        upstart: up_start || ""
      };
      
      try {
        const data = new TextEncoder().encode(JSON.stringify(payload));
        await writeChar.writeValueWithoutResponse(data);
        log(`已发送 ROS2 配置 → ROBOT_NAME: ${robot_name || '空'}`, 'success');
        saveRos2Config();
      } catch (error) {
        handleSendError(error);
      }
    });

    // 获取配置信息按钮事件
    getParamsBtn.addEventListener('click', async () => {
      const payload = { 
        cmd: "get_param"
      };
      try {
        log('正在获取设备配置信息...', 'info');
        const data = new TextEncoder().encode(JSON.stringify(payload));
        await writeChar.writeValueWithoutResponse(data);
        log('已发送获取配置信息命令', 'success');
      } catch (error) {
        handleSendError(error);
      }
    });

    // 关机按钮事件
    powerOffBtn.addEventListener('click', () => {
      showConfirmModal();
    });

    // 显示确认对话框
    function showConfirmModal() {
      confirmModal.classList.add('show');
    }

    // 隐藏确认对话框
    function hideConfirmModal() {
      confirmModal.classList.remove('show');
    }

    // 取消关机
    cancelPowerOff.addEventListener('click', () => {
      hideConfirmModal();
    });

    // 确认关机
    confirmPowerOff.addEventListener('click', async () => {
      hideConfirmModal();
      
      const payload = { 
        cmd: "power_off"
      };
      try {
        log('正在发送关机命令...', 'info');
        const data = new TextEncoder().encode(JSON.stringify(payload));
        await writeChar.writeValueWithoutResponse(data);
        log('已发送关机命令，设备将在几秒内关闭', 'success');
      } catch (error) {
        handleSendError(error);
      }
    });

    // 点击背景遮罩关闭对话框
    confirmModal.addEventListener('click', (e) => {
      if (e.target === confirmModal) {
        hideConfirmModal();
      }
    });

    // 标签页切换逻辑
    function switchTab(tabName) {
      // 检查标签页是否被禁用
      if (tabName === 'ros1' && ros1TabBtn.classList.contains('disabled')) {
        log('ROS1 配置在当前设备上不可用', 'info');
        return;
      }
      if (tabName === 'ros2' && ros2TabBtn.classList.contains('disabled')) {
        log('ROS2 配置在当前设备上不可用', 'info');
        return;
      }
      
      if (tabName === 'ros1') {
        ros1TabBtn.classList.add('active');
        ros2TabBtn.classList.remove('active');
        ros1Panel.classList.add('active');
        ros2Panel.classList.remove('active');
      } else if (tabName === 'ros2') {
        ros1TabBtn.classList.remove('active');
        ros2TabBtn.classList.add('active');
        ros1Panel.classList.remove('active');
        ros2Panel.classList.add('active');
      }
    }
    ros1TabBtn.addEventListener('click', () => switchTab('ros1'));
    ros2TabBtn.addEventListener('click', () => switchTab('ros2'));

    // 页面加载：恢复上次输入
    window.addEventListener('load', async () => {
      loadSavedConfigs();
      
      // 设置输入验证
      setupInputValidation();

      if (await checkBluetooth()) {
        await autoConnect();
      }
    });
  </script>

</body>
</html>
